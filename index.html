<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Planejador de Agenda Interativo</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Biblioteca para gerar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
    <div id="app">
        <div id="mainView" class="main-view">
            <div class="header no-print">
                <button id="prevNav" class="btn-nav-arrow">‚Äπ</button>
                <div class="header-title">
                    <h1 id="headerTitle">Dez 2025</h1>
                </div>
                <button id="nextNav" class="btn-nav-arrow">‚Ä∫</button>
            </div>

            <div class="view-controls no-print">
                <button id="viewWeekly" class="view-btn active">üìÖ Semanal</button>
                <button id="viewMonthly" class="view-btn">üìÜ Mensal</button>
                <div class="print-group">

                    <button id="printMonthBtn" class="btn btn-print">üñ®Ô∏è Imprimir M√™s</button>
                    <button id="printWeekBtn" class="btn btn-print">üñ®Ô∏è Imprimir Semana</button>
                </div>
                <button id="exportPdfBtn" class="btn btn-pdf" style="display:none;">üìÑ Exportar PDF</button>
                <button id="exportDataBtn" class="btn btn-backup">üì§ Exportar Backup</button>
                <button id="importDataBtn" class="btn btn-backup">üì• Importar Backup</button>
                <input type="file" id="importFile" style="display:none" accept=".json">
            </div>

            <div id="weekView" class="week-view-container">
                <div id="weekGrid" class="week-grid"></div>
            </div>

            <div id="monthView" class="month-view" style="display: none;">
                <div id="monthPrintHeader" class="month-print-header" style="display: none;">
                    <h1 id="monthPrintTitle"></h1>
                </div>
                <div id="monthCalendar" class="month-calendar"></div>
            </div>
        </div>

        <div id="dayEditView" class="day-edit-view" style="display: none;">
            <div class="edit-header no-print">
                <div class="edit-header-left">
                    <span id="editDayInfo" class="edit-day-info"></span>
                </div>
                <div class="edit-header-right">
                    <button id="printDay" class="btn btn-primary">üñ®Ô∏è Imprimir</button>
                    <button id="closeDayEdit" class="btn btn-secondary">‚úï Fechar</button>
                </div>
            </div>

            <div class="edit-toolbar no-print">
                <div class="toolbar-row">
                    <div class="toolbar-group">
                        <button onclick="formatDoc('bold')" title="Negrito"><b>B</b></button>
                        <button onclick="formatDoc('italic')" title="It√°lico"><i>I</i></button>
                        <button onclick="formatDoc('underline')" title="Sublinhado"><u>U</u></button>
                        <button onclick="formatDoc('strikeThrough')" title="Tracejado"><s>S</s></button>
                    </div>
                    <div class="toolbar-group">
                        <select onchange="formatDoc('fontSize', this.value); this.selectedIndex=0;">
                            <option value="">Tamanho</option>
                            <option value="1">Muito Pequeno</option>
                            <option value="2">Pequeno</option>
                            <option value="3">Normal</option>
                            <option value="4">Grande</option>
                            <option value="5">Muito Grande</option>
                            <option value="6">Enorme</option>
                        </select>
                    </div>
                </div>
                <div class="toolbar-row">
                    <div class="toolbar-group" style="width: 100%;">
                        <span class="label">Cores:</span>
                        <div id="colorPalette" class="color-buttons"></div>
                    </div>
                </div>
            </div>

            <div class="edit-content">
                <div id="dayPrintHeader" class="print-only day-print-header">
                    <div class="print-date" id="printDate"></div>
                    <div class="print-day-name" id="printDayName"></div>
                    <hr class="print-divider">
                </div>
                <div class="notebook-container">
                    <div id="notebookLines" class="notebook-lines"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== CONFIGURA√á√ïES E ESTADO ==========
        var COLORS = ['#FF0000', '#FF6B00', '#FFD700', '#00D000', '#00B8D4', '#0066FF', '#6600FF', '#FF00FF', '#FF1493', '#00FF7F', '#FF4500', '#1E90FF', '#DC143C', '#00CED1', '#FFB6C1', '#32CD32', '#FF8C00', '#00FF00', '#FF69B4', '#000000', '#808080', '#FFFFFF'];
        var FERIADOS_BRASIL = ['01-01', '02-13', '04-21', '05-01', '09-07', '10-12', '11-02', '11-20', '12-25'];
        
        var appState = {
            currentDate: new Date(),
            selectedDay: null,
            selectedLineIndex: null,
            days: {},
            view: 'week'
        };

        // ========== UTILIT√ÅRIOS ==========
        function getDateString(date) {
            var y = date.getFullYear();
            var m = String(date.getMonth() + 1).padStart(2, '0');
            var d = String(date.getDate()).padStart(2, '0');
            return y + '-' + m + '-' + d;
        }

        function getDayName(dayIndex) {
            var days = ['Domingo', 'Segunda-feira', 'Ter√ßa-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'S√°bado'];
            return days[dayIndex];
        }

        function isHolidayDate(date) {
            var m = String(date.getMonth() + 1).padStart(2, '0');
            var d = String(date.getDate()).padStart(2, '0');
            return FERIADOS_BRASIL.indexOf(m + '-' + d) !== -1;
        }

        function isDarkColor(color) {
            if (!color) return false;
            if (color.startsWith('rgb')) {
                var rgb = color.match(/\d+/g);
                var r = parseInt(rgb[0]), g = parseInt(rgb[1]), b = parseInt(rgb[2]);
            } else {
                var hex = color.replace('#', '');
                if (hex.length === 3) hex = hex.split('').map(function(s){return s+s}).join('');
                var r = parseInt(hex.substr(0, 2), 16);
                var g = parseInt(hex.substr(2, 2), 16);
                var b = parseInt(hex.substr(4, 2), 16);
            }
            var luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            return luminance < 0.5;
        }

        function formatDoc(cmd, val) {
            if (cmd === 'hiliteColor') {
                document.execCommand('hiliteColor', false, val);
                // Aplicar cor de texto contrastante automaticamente
                var textColor = isDarkColor(val) ? '#FFFFFF' : '#000000';
                document.execCommand('foreColor', false, textColor);
            } else {
                document.execCommand(cmd, false, val);
            }
            
            if (appState.selectedLineIndex !== null) {
                var el = document.querySelector('[data-index="' + appState.selectedLineIndex + '"]');
                if (el) updateLine(appState.selectedLineIndex, el);
            }
        }

        // ========== ARMAZENAMENTO ==========
        function saveData() { localStorage.setItem('plannerData', JSON.stringify(appState.days)); }
        function loadData() {
            var stored = localStorage.getItem('plannerData');
            if (stored) appState.days = JSON.parse(stored);
        }

        // ========== RENDERIZA√á√ÉO ==========
        function renderWeekView() {
            var weekGrid = document.getElementById('weekGrid');
            if (!weekGrid) return;
            weekGrid.innerHTML = '';

            var startDate = new Date(appState.currentDate);
            var dayOfWeek = appState.currentDate.getDay();
            // Ajustar para come√ßar na Segunda-feira (1) e terminar no Domingo (0)
            var daysToSubtract = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            startDate.setDate(appState.currentDate.getDate() - daysToSubtract);

            document.getElementById('headerTitle').textContent = startDate.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' }).toUpperCase();

            var leftCol = document.createElement('div'); leftCol.className = 'week-column no-print';
            var rightCol = document.createElement('div'); rightCol.className = 'week-column no-print';

            for (var i = 0; i < 7; i++) {
                var date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                // Criar o card uma √∫nica vez
                var card = createDayCard(date);
                
                // Adicionar ao container de tela (que ser√° oculto na impress√£o)
                var screenClone = card.cloneNode(true);
                screenClone.classList.add('no-print');
                screenClone.onclick = (function(d) {
                    return function() { openDayEdit(new Date(d)); };
                })(date);
                if (i < 4) leftCol.appendChild(screenClone); else rightCol.appendChild(screenClone);
                
                // Adicionar ao container de impress√£o (que ser√° oculto na tela)
                var printClone = card.cloneNode(true);
                printClone.classList.add('print-only');
                weekGrid.appendChild(printClone);
            }

            weekGrid.appendChild(leftCol);
            
            // Adicionar espiral entre as colunas
            var spiral = document.createElement('div');
            spiral.className = 'week-spiral-divider no-print';
            weekGrid.appendChild(spiral);
            
            weekGrid.appendChild(rightCol);
            
            document.getElementById('weekView').style.display = 'flex';
            document.getElementById('monthView').style.display = 'none';
            document.getElementById('viewWeekly').classList.add('active');
            document.getElementById('viewMonthly').classList.remove('active');
            document.getElementById('exportPdfBtn').style.display = 'inline-block'; // Habilitar PDF na semana
        }

        function createDayCard(date) {
            var card = document.createElement('div');
            var dateStr = getDateString(date);
            var isWeekend = date.getDay() === 0 || date.getDay() === 6;
            var isHoliday = isHolidayDate(date);
            var isSpecial = isWeekend || isHoliday;
            
            card.className = 'day-card-grid' + (isSpecial ? ' special-day' : '');
            
            // Cabe√ßalho para tela
            var header = document.createElement('div');
            header.className = 'day-card-header no-print' + (isSpecial ? ' special-day' : '');
            var dayNameShort = getDayName(date.getDay()).split('-')[0].toUpperCase();
            header.innerHTML = '<span class="day-name-label">' + dayNameShort + ' ' + date.getDate() + '</span>';
            
            // Cabe√ßalho para impress√£o (estilo agenda circular)
            var printHeader = document.createElement('div');
            printHeader.className = 'print-only day-print-header-agenda';
            var day = date.getDate();
            var dayNameShort = getDayName(date.getDay()).split('-')[0].toUpperCase();
            
            var headerColor = isSpecial ? 'color: #FF0000 !important;' : 'color: #000000 !important;';
            var bgColor = isSpecial ? 'background-color: #FFE6E6 !important;' : 'background-color: #F0F0F0 !important;';
            
            printHeader.innerHTML = '<div class="print-day-name-label" style="' + headerColor + '">' + dayNameShort + '</div>' +
                                   '<div class="print-day-number-circle" style="' + headerColor + bgColor + '">' + day + '</div>';

            var content = document.createElement('div');
            content.className = 'day-card-content';
            
            var dayData = appState.days[dateStr] || { lines: [] };
            var hasAnyContent = false;
            
            var contentLines = [];
            for (var i = 0; i < 30; i++) {
                var line = dayData.lines[i] || { text: '' };
                var hasContent = !!(line.text || line.html) && (line.text || "").trim() !== "";
                if (hasContent) {
                    hasAnyContent = true;
                    contentLines.push({ index: i + 1, data: line });
                }
                
                // Renderizar para tela (comportamento original)
                var lineWrap = document.createElement('div');
                lineWrap.className = 'day-line-wrapper no-print' + (hasContent ? ' has-content' : ' empty-line');
                lineWrap.innerHTML = '<span class="line-number-preview" style="color:#bbb;">' + (i+1) + '.</span><div class="day-line-preview">' + (line.html || line.text || '&nbsp;') + '</div>';
                content.appendChild(lineWrap);
            }

            // Renderizar as 30 linhas para impress√£o (estilo caderno)
            var printContainer = document.createElement('div');
            printContainer.className = 'print-only day-print-container-agenda';
            
            for (var i = 0; i < 30; i++) {
                var line = dayData.lines[i] || { text: '' };
                var hasContent = !!(line.text || line.html);
                
                var pWrap = document.createElement('div');
                pWrap.className = 'day-line-wrapper-agenda print-only' + (hasContent ? ' has-content' : ' empty-line');
                
                var cleanHtml = (line.html || line.text || '&nbsp;');
                
                pWrap.innerHTML = '<div class="day-line-preview-agenda" style="font-size: 7px; word-break: break-word; line-height: 1.2;">' + 
                                 (hasContent ? '<span class="line-number-agenda">' + (i + 1) + '. </span>' + cleanHtml : '&nbsp;') + 
                                 '</div>';
                
                printContainer.appendChild(pWrap);
            }
            content.appendChild(printContainer);

            card.appendChild(header);
            card.appendChild(printHeader);
            card.appendChild(content);
            if (hasAnyContent) card.classList.add('has-content');
            card.onclick = (function(d) {
                return function() { openDayEdit(new Date(d)); };
            })(date);
            return card;
        }

        function renderMonthView() {
            var monthCalendar = document.getElementById('monthCalendar');
            monthCalendar.innerHTML = '';
            var monthTitle = (appState.currentDate.getMonth() + 1).toString().padStart(2, '0') + '/' + appState.currentDate.getFullYear();
            document.getElementById('headerTitle').textContent = monthTitle;
            document.getElementById('monthPrintTitle').textContent = monthTitle;

            var grid = document.createElement('div'); grid.className = 'month-grid';
            // Layout conforme imagem: Segunda a S√°bado em uma linha, Domingo separado ou ao final
            // O modelo mostra Segunda, Ter√ßa, Quarta, Quinta, Sexta, S√°bado e Domingo por √∫ltimo
            var dayNames = ['SEGUNDA', 'TER√áA', 'QUARTA', 'QUINTA', 'SEXTA', 'S√ÅBADO', 'DOMINGO'];
            dayNames.forEach(function(d) {
                var h = document.createElement('div'); 
                h.className = 'month-day-header' + (d === 'S√ÅBADO' || d === 'DOMINGO' ? ' special-day' : ''); 
                h.textContent = d; 
                grid.appendChild(h);
            });

            var firstDay = new Date(appState.currentDate.getFullYear(), appState.currentDate.getMonth(), 1);
            var startDayOfWeek = firstDay.getDay();
            var diff = startDayOfWeek === 0 ? 6 : startDayOfWeek - 1;
            var start = new Date(firstDay); 
            start.setDate(firstDay.getDate() - diff);

            // Calcular o n√∫mero de semanas necess√°rias (5 ou 6)
            var lastDayOfMonth = new Date(appState.currentDate.getFullYear(), appState.currentDate.getMonth() + 1, 0);
            var totalDaysNeeded = diff + lastDayOfMonth.getDate();
            var totalCells = Math.ceil(totalDaysNeeded / 7) * 7;
            var numRows = totalCells / 7;
            grid.style.gridTemplateRows = '35px repeat(' + numRows + ', 1fr)';

            for (var i = 0; i < totalCells; i++) {
                var date = new Date(start); 
                date.setDate(start.getDate() + i);
                grid.appendChild(createMonthCell(date));
            }

            monthCalendar.appendChild(grid);
            document.getElementById('weekView').style.display = 'none';
            document.getElementById('monthView').style.display = 'flex';
            document.getElementById('viewWeekly').classList.remove('active');
            document.getElementById('viewMonthly').classList.add('active');
            document.getElementById('exportPdfBtn').style.display = 'inline-block';
        }

        function createMonthCell(date) {
            var cell = document.createElement('div');
            var isOther = date.getMonth() !== appState.currentDate.getMonth();
            
            if (isOther) {
                cell.className = 'month-day-cell other-month';
                cell.innerHTML = '&nbsp;';
                return cell;
            }
            
            var isWeekend = date.getDay() === 0 || date.getDay() === 6;
            var isHoliday = isHolidayDate(date);
            var isSpecial = isWeekend || isHoliday;
            
            cell.className = 'month-day-cell' + (isSpecial ? ' special-day' : '');
            
            var dateStr = getDateString(date);
            var dayData = appState.days[dateStr];
            var html = '<div class="month-day-num-container"><div class="month-day-num">' + date.getDate() + '</div></div>';
            
            if (dayData && dayData.lines) {
		                var contentLines = [];
		                dayData.lines.forEach(function(l, idx) {
		                    if (l && (l.text || l.html) && (l.text || "").trim() !== "") {
		                        contentLines.push({ index: idx + 1, data: l });
		                    }
		                });
                        if (contentLines.length > 0) cell.classList.add('has-content');
	
	                // L√≥gica para tela (comportamento original)
	                html += '<div class="month-cell-content no-print">';
	                contentLines.forEach(function(item) {
	                    var cleanHtml = (item.data.html || item.data.text);
	                    html += '<div class="month-line-rich"><span class="line-num">' + item.index + '.</span> ' + cleanHtml + '</div>';
	                });
	                html += '</div>';
	
                // L√≥gica para Impress√£o/PDF (Exibir anota√ß√µes di√°rias no grid)
                html += '<div class="month-cell-content print-only">';
                contentLines.forEach(function(item) {
                    var cleanHtml = (item.data.html || item.data.text);
                    html += '<div class="month-line-rich"><span class="line-num">' + item.index + '.</span> ' + cleanHtml + '</div>';
                });
                html += '</div>';
            }
            html += '</div>';
            
            cell.innerHTML = html;
            cell.onclick = function() { openDayEdit(new Date(date)); };
            return cell;
        }

        function openDayEdit(date) {
            // Garantir que a data seja tratada corretamente
            var targetDate = new Date(date);
            appState.selectedDay = getDateString(targetDate);
            var dayData = appState.days[appState.selectedDay] || { lines: [] };
            document.getElementById('editDayInfo').textContent = getDayName(targetDate.getDay()) + ', ' + targetDate.getDate();
            
            // Atualizar cabe√ßalho de impress√£o com a data correta do dia selecionado
            var day = String(targetDate.getDate()).padStart(2, '0');
            var month = String(targetDate.getMonth() + 1).padStart(2, '0');
            var year = targetDate.getFullYear();
            document.getElementById('printDate').textContent = day + '/' + month + '/' + year;
            document.getElementById('printDayName').textContent = getDayName(targetDate.getDay());

            var notebook = document.getElementById('notebookLines');
            document.body.classList.add('editing-day');
            notebook.innerHTML = '';
            
            // Container para colunas de impress√£o di√°ria
            var printColumns = document.createElement('div');
            printColumns.className = 'print-only day-print-columns';
            var col1 = document.createElement('div'); col1.className = 'print-col';
            var col2 = document.createElement('div'); col2.className = 'print-col';
            var col3 = document.createElement('div'); col3.className = 'print-col';
            printColumns.appendChild(col1);
            printColumns.appendChild(col2);
            printColumns.appendChild(col3);
            
            var contentLines = [];
            for (var i = 0; i < 30; i++) {
                var lineData = dayData.lines[i] || { text: '' };
                var hasContent = !!(lineData.text || lineData.html);
                if (hasContent) contentLines.push({ index: i + 1, data: lineData });

                // Renderizar para tela (comportamento original)
                var wrap = document.createElement('div');
                wrap.className = 'notebook-line-wrapper no-print' + (hasContent ? ' has-content' : ' empty-line');
                var line = document.createElement('div');
                line.className = 'notebook-line';
                line.contentEditable = true;
                line.setAttribute('data-index', i);
                line.innerHTML = lineData.html || lineData.text || '';
                
                line.oninput = function() { 
                    updateLine(this.getAttribute('data-index'), this);
                    adjustFontSize(this, 24);
                };
                line.onfocus = function() { appState.selectedLineIndex = parseInt(this.getAttribute('data-index')); };
                
                if (hasContent) {
                    setTimeout((function(el) {
                        return function() { adjustFontSize(el, 24); };
                    })(line), 0);
                }
                
                line.onkeydown = function(e) {
                    var idx = parseInt(this.getAttribute('data-index'));
                    if (e.key === 'Enter' || e.key === 'Tab') {
                        e.preventDefault();
                        var nextIdx = idx + 1;
                        if (nextIdx < 30) {
                            var nextEl = document.querySelector('[data-index="' + nextIdx + '"]');
                            if (nextEl) nextEl.focus();
                        }
                    }
                };
                
                wrap.innerHTML = '<div class="line-number">' + (i+1) + '.</div>';
                wrap.appendChild(line);
                notebook.appendChild(wrap);
            }

            // Renderizar para impress√£o di√°ria (colunas se > 10 linhas)
            if (contentLines.length > 0) {
                var numCols = 1;
                if (contentLines.length > 20) numCols = 3;
                else if (contentLines.length > 10) numCols = 2;

                contentLines.forEach(function(item, idx) {
                    var lineWrap = document.createElement('div');
                    lineWrap.className = 'notebook-line-wrapper has-content';
                    var cleanHtml = (item.data.html || item.data.text);
                    lineWrap.innerHTML = '<div class="line-number">' + item.index + '.</div><div class="notebook-line">' + cleanHtml + '</div>';
                    
                    var colIdx = idx % numCols;
                    if (colIdx === 0) col1.appendChild(lineWrap);
                    else if (colIdx === 1) col2.appendChild(lineWrap);
                    else col3.appendChild(lineWrap);
                });
                notebook.appendChild(printColumns);
            }

            document.getElementById('dayEditView').style.display = 'flex';
            document.getElementById('mainView').style.display = 'none';
            renderColorPalette();
        }

        function adjustFontSize(element, maxHeight) {
            var fontSize = 16; // Tamanho original
            if (element.classList.contains('day-line-preview')) fontSize = 10; // Tamanho original semanal
            
            element.style.fontSize = fontSize + 'px';
            element.style.fontWeight = 'normal'; // Peso original
            while (element.scrollHeight > maxHeight && fontSize > 6) {
                fontSize -= 0.5;
                element.style.fontSize = fontSize + 'px';
            }
        }

        function updateLine(idx, el) {
            if (!appState.days[appState.selectedDay]) appState.days[appState.selectedDay] = { lines: [] };
            appState.days[appState.selectedDay].lines[idx] = { text: el.innerText, html: el.innerHTML };
            
            // Atualizar classe has-content no wrapper para impress√£o
            var wrap = el.parentElement;
            if (wrap && wrap.classList.contains('notebook-line-wrapper')) {
                if (el.innerText.trim() !== '' || el.innerHTML.trim() !== '') {
                    wrap.classList.add('has-content');
                    wrap.classList.remove('empty-line');
                } else {
                    wrap.classList.remove('has-content');
                    wrap.classList.add('empty-line');
                }
            }
            saveData();
        }

        function renderColorPalette() {
            var p = document.getElementById('colorPalette'); p.innerHTML = '';
            COLORS.forEach(function(c, i) {
                var b = document.createElement('button'); b.className = 'color-btn'; b.style.backgroundColor = c;
                b.onclick = function() {
                    formatDoc('hiliteColor', c);
                };
                p.appendChild(b);
            });
        }

        function closeDayEdit() {
            document.getElementById('dayEditView').style.display = 'none';
            document.getElementById('mainView').style.display = 'flex';
            document.body.classList.remove('editing-day');
            renderWeekView();
        }

        function exportToPdf() {
            var isWeek = appState.view === 'week';
            var element = isWeek ? document.getElementById('weekView') : document.getElementById('monthView');
            
            // Criar um clone do elemento para n√£o afetar a tela durante a gera√ß√£o
            var clone = element.cloneNode(true);
            
            // Se for mensal, garantir que o cabe√ßalho de impress√£o esteja vis√≠vel e limpo
            if (!isWeek) {
                // Remover TUDO que n√£o seja o t√≠tulo mensal e o grid
                var allElements = clone.querySelectorAll('*');
                allElements.forEach(function(el) {
                    if (el.id === 'monthPrintHeader' || el.id === 'monthCalendar' || el.classList.contains('month-grid') || el.closest('#monthCalendar')) {
                        // Manter elementos do calend√°rio mensal
                    } else if (el.id === 'monthView' || el.id === 'monthPrintTitle' || el.id === 'app' || el.classList.contains('main-view')) {
                        // Manter containers principais
                    } else {
                        // Remover o resto para garantir que nada do semanal apare√ßa
                        el.remove(); // Remover fisicamente do DOM do clone para evitar resqu√≠cios
                    }
                });

                var printHeader = clone.querySelector('#monthPrintHeader');
                if (printHeader) {
                    printHeader.style.setProperty('display', 'block', 'important');
                    printHeader.style.textAlign = 'center';
                    printHeader.style.marginBottom = '20px';
                    printHeader.style.borderBottom = '2px solid #000';
                    printHeader.style.width = '100%';
                }
            }
            
            // Configurar o clone para o estado de impress√£o
            clone.style.background = 'white';
            if (isWeek) {
                clone.style.width = '1122px'; // Largura A4 Paisagem em pixels (96dpi)
                
                // For√ßar visibilidade dos elementos de impress√£o no clone
                var printOnly = clone.querySelectorAll('.print-only');
                printOnly.forEach(function(el) { el.style.setProperty('display', 'block', 'important'); });
                var noPrint = clone.querySelectorAll('.no-print');
                noPrint.forEach(function(el) { el.style.setProperty('display', 'none', 'important'); });
                
                // Ajuste para o layout de grid semanal no PDF (conforme imagem)
                var grid = clone.querySelector('#weekGrid');
                if (grid) {
                    grid.style.display = 'flex'; // Usar flex para melhor compatibilidade com Safari
                    grid.style.flexDirection = 'row';
                    grid.style.alignItems = 'stretch';
                    grid.style.width = '100%';
                    grid.style.borderTop = '1px solid #000';
                    grid.style.borderLeft = '1px solid #000';
                    grid.style.borderBottom = '1px solid #000'; // Borda inferior do grid todo
                }

                var allCards = clone.querySelectorAll('.day-card-grid');
                allCards.forEach(function(card) {
                    card.style.display = 'block';
                    card.style.width = '100%';
                    card.style.height = 'auto';
                    card.style.minHeight = '100%';
                    card.style.borderRight = '1px solid #000';
                    card.style.borderBottom = 'none'; // Removido borda inferior
                    card.style.padding = '2px';
                    card.style.flex = '1'; // Garantir que as colunas se distribuam igualmente
                    
                    var content = card.querySelector('.day-card-content');
                    if (content) {
                        content.style.height = 'auto';
                        // Ocultar o container de tela e mostrar o de impress√£o
                        var screenLines = content.querySelectorAll('.day-line-wrapper.no-print');
                        screenLines.forEach(function(l) { l.style.display = 'none'; });
                        
                        var printContainer = content.querySelector('.day-print-container-agenda');
                        if (printContainer) {
                            printContainer.style.display = 'block';
                            printContainer.style.border = 'none';
                            
                            var lines = printContainer.querySelectorAll('.day-line-wrapper-agenda');
                            lines.forEach(function(line) {
                                // No semanal, mostramos apenas as linhas que t√™m conte√∫do para economizar espa√ßo
                                // mas garantimos que TODAS as que t√™m conte√∫do apare√ßam sem cortes
                                if (line.classList.contains('has-content')) {
                                    line.style.setProperty('display', 'block', 'important');
                                    line.style.setProperty('height', 'auto', 'important');
                                    line.style.setProperty('min-height', '0', 'important');
                                    line.style.setProperty('border-bottom', 'none', 'important');
                                    line.style.setProperty('padding', '2px 0', 'important');
                                    line.style.setProperty('visibility', 'visible', 'important');
                                    line.style.setProperty('overflow', 'visible', 'important');
                                    
                                    var preview = line.querySelector('.day-line-preview-agenda');
                                    if (preview) {
                                        preview.style.setProperty('white-space', 'normal', 'important');
                                        preview.style.setProperty('word-break', 'break-word', 'important');
                                        preview.style.setProperty('height', 'auto', 'important');
                                        preview.style.setProperty('overflow', 'visible', 'important');
                                    }
                                } else {
                                    line.style.setProperty('display', 'none', 'important');
                                }
                            });
                        }
                    }
                });
            } else {
                // Ajustes espec√≠ficos para o clone mensal no PDF
                var grid = clone.querySelector('.month-grid');
                if (grid) {
                    grid.style.display = 'grid';
                    grid.style.gridTemplateColumns = 'repeat(7, 1fr)';
                    grid.style.gridAutoRows = 'auto';
                    grid.style.width = '100%';
                    grid.style.gap = '0';
                }
                
                    var cells = clone.querySelectorAll('.month-day-cell');
                    cells.forEach(function(cell) {
                        cell.style.height = 'auto';
                        cell.style.minHeight = cell.classList.contains('has-content') ? '80px' : '40px';
                        cell.style.border = '1px solid #000';
                    
                    var content = cell.querySelector('.month-cell-content.print-only');
                    if (content) {
                        content.style.display = 'block';
                        content.style.fontSize = '7px';
                    }
                });
            }

            var filename = (isWeek ? 'semana-' : 'calendario-') + 
                           appState.currentDate.getFullYear() + '-' + (appState.currentDate.getMonth()+1) + '.pdf';

            var opt = {
                margin: 5,
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2, 
                    useCORS: true, 
                    logging: false,
                    letterRendering: true
                },
                jsPDF: { unit: 'mm', format: 'a2', orientation: 'landscape' }
            };
            
            // Adicionar classe tempor√°ria ao body para estilos globais de impress√£o
            document.body.classList.add('print-mode');
            if (isWeek) document.body.classList.add('print-weekly-landscape');
            
            html2pdf().set(opt).from(clone).save().then(function() {
                document.body.classList.remove('print-mode');
                document.body.classList.remove('print-weekly-landscape');
            });
        }

        // ========== INICIALIZA√á√ÉO ==========
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            renderWeekView();
            document.getElementById('prevNav').onclick = function() {
                if (appState.view === 'week') appState.currentDate.setDate(appState.currentDate.getDate() - 7);
                else appState.currentDate.setMonth(appState.currentDate.getMonth() - 1);
                appState.view === 'week' ? renderWeekView() : renderMonthView();
            };
            document.getElementById('nextNav').onclick = function() {
                if (appState.view === 'week') appState.currentDate.setDate(appState.currentDate.getDate() + 7);
                else appState.currentDate.setMonth(appState.currentDate.getMonth() + 1);
                appState.view === 'week' ? renderWeekView() : renderMonthView();
            };
            document.getElementById('viewWeekly').onclick = function() { appState.view = 'week'; renderWeekView(); };
            document.getElementById('viewMonthly').onclick = function() { appState.view = 'month'; renderMonthView(); };
            document.getElementById('closeDayEdit').onclick = closeDayEdit;
            document.getElementById('exportPdfBtn').onclick = exportToPdf;
            
            document.getElementById('printWeekBtn').onclick = function() {
                appState.view = 'week';
                renderWeekView();
                var size = 'A4';
                document.body.className = document.body.className.replace(/print-size-\w+/g, '');
                document.body.classList.add('print-size-' + size);
                document.body.classList.add('print-weekly-landscape');
                setTimeout(function() { 
                    window.print(); 
                    document.body.classList.remove('print-weekly-landscape');
                }, 500);
            };
            
            document.getElementById('printMonthBtn').onclick = function() {
                appState.view = 'month';
                renderMonthView();
                var size = 'A4';
                document.body.className = document.body.className.replace(/print-size-\w+/g, '');
                document.body.classList.add('print-size-' + size);
                document.body.classList.add('print-monthly-landscape');
                setTimeout(function() { 
                    window.print(); 
                    document.body.classList.remove('print-monthly-landscape');
                }, 500);
            };
            
            document.getElementById('printDay').onclick = function() {
                window.print();
            };

            // ========== L√ìGICA DE BACKUP (EXPORTAR/IMPORTAR) ==========
            document.getElementById('exportDataBtn').onclick = function() {
                var dataStr = JSON.stringify(appState.days, null, 2);
                var dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                var exportFileDefaultName = 'backup-planejador-' + new Date().toISOString().slice(0,10) + '.json';
                
                var linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            };

            document.getElementById('importDataBtn').onclick = function() {
                document.getElementById('importFile').click();
            };

            document.getElementById('importFile').onchange = function(event) {
                var file = event.target.files[0];
                if (!file) return;
                
                var reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        var importedData = JSON.parse(e.target.result);
                        if (confirm('Isso ir√° substituir todas as suas anota√ß√µes atuais. Deseja continuar?')) {
                            appState.days = importedData;
                            saveData();
                            location.reload();
                        }
                    } catch (err) {
                        alert('Erro ao importar arquivo: ' + err.message);
                    }
                };
                reader.readAsText(file);
            };
        });
    </script>
</body>
</html>
